@page "/EventPage/{Id:int}"
@using Microsoft.AspNetCore.Authorization;
@using Newtonsoft.Json;
@using System.Web;
@using TicketHive_MadCats.Client.Cookies;
@using TicketHive_MadCats.Shared.ViewModels;
@inject HttpClient client
@inject NavigationManager navMan
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<body>
    @if (Event != null)

    {

        @if (Event.BookedTickets >= Event.MaxTickets)
        {
            <em class="color text-danger">  Event is fully booked!</em>
        }
        else
        {
            <h2>Name: @Event.Name</h2>
            <br />
            <h2>Event type: @Event.EventType</h2>
            <br />
            <h2>Event Price: @Event.TicketPrice kr</h2>
            <br />
            <h2>Location: @Event.Location</h2>
            <br />
            <h2>Date: @Event.Date</h2>
            <br />
            <h2>Tickets available: @totalEvents();</h2>
            <br />
            @foreach (var ImgPath in ImgPaths)
            {
                <img src=@ImgPath width="250" height="250" style="margin-right: 10px;">

            }
            <br />
            <div>
                <label for="numberInput">Quantity:</label>
                <input type="number" id="numberInput" @bind-value="@myNumber" @bind-value:event="oninput"/>
                @if (showWarning)
                {
                    <span style="color:red">Please enter a number</span>
                }
                @if ((myNumber <= Event.MaxTickets - Event.BookedTickets) && myNumber >0)
                {
                    <button @onclick="HandleSubmit">book @myNumber</button>

                }
                @if (formSubmitted)
                {
                    <span style="color:green">Ticket(s) are booked!</span>
                }
            </div>
            <button>
                <a href="@($"/CartPage?event={Uri.EscapeDataString(JsonConvert.SerializeObject(Event))}")">Go to cart</a>
                @*<button @onclick="() => navMan.NavigateTo(CartUrl)" style="margin: 10px;">Go to cart page!</button>*@
            </button>

        }
    }
    else
    {
        <h3>Loading events... </h3>
    }
    <div>
        <button @onclick="() => navMan.NavigateTo(IndexUrl)" style="margin: 10px;">Go to HomePage</button>
    </div>

</body>


<style>
    html, body {
        background-color: #F0F0F0;
        color: #305076;
    }
</style>

@code {
    [Parameter]
    public int Id { get; set; }
    [Inject]
    HttpClient codeClient { get; set; }
    [Inject]
    IJSRuntime jS { get; set; }
    [Inject]
    NavigationManager navMana { get; set; }

    CookieInterpreter? cookieInterpreter;

    public EventViewModel? Event;
    public List<string> ImgPaths;
    public string IndexUrl { get; set; } = "/";
    public string CartUrl { get; set; } = "/Cartpage";

    private int myNumber;
    private bool showWarning = false;
    private bool formSubmitted;



    protected override async Task OnInitializedAsync()
    {
        Event = await GetOneEvent();
        DeserializeImgs();

    }

    protected override async Task OnParametersSetAsync()
    {
        cookieInterpreter = new(jS);
    }

    public void DeserializeImgs()
    {
        if(Event != null)
        {
            ImgPaths = JsonConvert.DeserializeObject<List<string>>(Event.ImageSrcs);
        }
    }


    public async Task<EventViewModel?> GetOneEvent()
    {
        var response = await codeClient.GetAsync($"api/Events/{Id}");
        var statusCode = response.StatusCode;
        if (statusCode == System.Net.HttpStatusCode.OK)
        {
            var responseBody = await response.Content.ReadAsStringAsync();
            EventViewModel? eventVM = JsonConvert.DeserializeObject<EventViewModel?>(responseBody);
            return eventVM;
        }
        return null; 

    }

    private async Task HandleSubmit()
    {
        formSubmitted = true;
        await cookieInterpreter.UpdateCookieForSingleEvent(Event.Name, myNumber);

        var serializedEvent = JsonConvert.SerializeObject(Event);
        var uri = navMan.ToAbsoluteUri($"/CartPage?event={Uri.EscapeDataString(serializedEvent)}&tickets={myNumber}");
        navMan.NavigateTo(uri.ToString());

    }


    public int totalEvents()
    {
        int TotalEvent = Event.MaxTickets - Event.BookedTickets;

        return TotalEvent;
    }
}
